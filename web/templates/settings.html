{% extends "base.html" %}

{% block title %}ç³»ç»Ÿè®¾ç½® - EDUKY-å•†å“ç›‘æ§ç³»ç»Ÿ{% endblock %}

{% block page_title %}ç³»ç»Ÿè®¾ç½®{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Telegram Bot é…ç½®
                </h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-4">
                        <label for="telegram_bot_token" class="form-label">
                            Telegram Bot Token <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="telegram_bot_token" name="telegram_bot_token" 
                               value="{{ config.telegram_bot_token or '' }}" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11">
                        <div class="form-text">
                            ä» <a href="https://t.me/botfather" target="_blank">@BotFather</a> è·å–Bot Token
                            <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="showBotHelp()">
                                <i class="fas fa-question-circle"></i> å¦‚ä½•åˆ›å»ºBotï¼Ÿ
                            </button>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- é¢‘é“é€šçŸ¥è®¾ç½® -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="channel_enabled" name="channel_enabled" 
                                       {% if config.channel_enabled %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="channel_enabled">
                                    <i class="fas fa-broadcast-tower me-1"></i>
                                    é¢‘é“é€šçŸ¥
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <label for="channel_id" class="form-label">é¢‘é“ID</label>
                                <input type="text" class="form-control" id="channel_id" name="channel_id" 
                                       value="{{ config.channel_id or '' }}" placeholder="@your_channel æˆ– -100123456789">
                                <div class="form-text">
                                    é¢‘é“ç”¨æˆ·åï¼ˆ@channelï¼‰æˆ–é¢‘é“IDï¼ˆæ•°å­—ï¼‰
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-outline-primary d-block" onclick="testNotification('channel')">
                                    <i class="fas fa-paper-plane me-1"></i> æµ‹è¯•é€šçŸ¥
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ç¾¤ç»„é€šçŸ¥è®¾ç½® -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="group_enabled" name="group_enabled" 
                                       {% if config.group_enabled %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="group_enabled">
                                    <i class="fas fa-users me-1"></i>
                                    ç¾¤ç»„é€šçŸ¥
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <label for="group_id" class="form-label">ç¾¤ç»„ID</label>
                                <input type="text" class="form-control" id="group_id" name="group_id" 
                                       value="{{ config.group_id or '' }}" placeholder="-987654321">
                                <div class="form-text">
                                    ç¾¤ç»„IDé€šå¸¸æ˜¯è´Ÿæ•°
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-outline-primary d-block" onclick="testNotification('group')">
                                    <i class="fas fa-paper-plane me-1"></i> æµ‹è¯•é€šçŸ¥
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸ªäººé€šçŸ¥è®¾ç½® -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="user_enabled" name="user_enabled" 
                                       {% if config.user_enabled %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="user_enabled">
                                    <i class="fas fa-user me-1"></i>
                                    ä¸ªäººé€šçŸ¥
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <label for="user_id" class="form-label">ç”¨æˆ·ID</label>
                                <input type="text" class="form-control" id="user_id" name="user_id" 
                                       value="{{ config.user_id or '' }}" placeholder="123456789">
                                <div class="form-text">
                                    æ‚¨çš„Telegramç”¨æˆ·IDï¼Œå¯ä» <a href="https://t.me/userinfobot" target="_blank">@userinfobot</a> è·å–
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-outline-primary d-block" onclick="testNotification('user')">
                                    <i class="fas fa-paper-plane me-1"></i> æµ‹è¯•é€šçŸ¥
                                </button>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- é€šçŸ¥ç±»å‹è®¾ç½® -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-bell me-1"></i>
                            é€šçŸ¥ç±»å‹è®¾ç½®
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="restock_enabled" name="restock_enabled" 
                                           {% if config.restock_enabled %}checked{% endif %}>
                                    <label class="form-check-label" for="restock_enabled">
                                        <i class="fas fa-arrow-up text-success me-1"></i>
                                        è¡¥è´§é€šçŸ¥
                                    </label>
                                </div>
                                <div class="form-text">åº“å­˜å¢åŠ æ—¶å‘é€é€šçŸ¥</div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="sale_enabled" name="sale_enabled" 
                                           {% if config.sale_enabled %}checked{% endif %}>
                                    <label class="form-check-label" for="sale_enabled">
                                        <i class="fas fa-arrow-down text-warning me-1"></i>
                                        é”€å”®é€šçŸ¥
                                    </label>
                                </div>
                                <div class="form-text">åº“å­˜å‡å°‘æ—¶å‘é€é€šçŸ¥</div>
                            </div>
                        </div>
                    </div>

                    <!-- æ£€æµ‹é—´éš”è®¾ç½® -->
                    <div class="mb-4">
                        <label for="check_interval" class="form-label">
                            <i class="fas fa-clock me-1"></i>
                            æ£€æµ‹é—´éš”ï¼ˆç§’ï¼‰
                        </label>
                        <input type="number" class="form-control" id="check_interval" name="check_interval" 
                               value="{{ config.check_interval or 60 }}" min="10" max="3600">
                        <div class="form-text">
                            æ¯éš”å¤šå°‘ç§’æ£€æµ‹ä¸€æ¬¡åº“å­˜å˜åŒ–ï¼Œæœ€å°10ç§’ï¼Œæœ€å¤§3600ç§’ï¼ˆ1å°æ—¶ï¼‰
                        </div>
                    </div>

                    <hr>

                    <!-- é€šçŸ¥æ¨¡æ¿è®¾ç½® -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-edit me-1"></i>
                            é€šçŸ¥æ¨¡æ¿è®¾ç½®
                        </h6>
                        
                        <!-- è¡¥è´§é€šçŸ¥æ¨¡æ¿ -->
                        <div class="mb-3">
                            <label for="template_restock" class="form-label">
                                <i class="fas fa-plus-circle text-success me-1"></i>
                                è¡¥è´§é€šçŸ¥æ¨¡æ¿
                            </label>
                            <textarea class="form-control" id="template_restock" name="template_restock" rows="5" 
                                      placeholder="è¡¥è´§é€šçŸ¥æ¨¡æ¿">{{ config.template_restock or "ğŸ‰ è¡¥è´§é€šçŸ¥\n\nğŸ“¦ å•†å“åç§°: {product_name}\nğŸ“ˆ è¡¥è´§æ•°é‡: {stock_difference} ä»¶\nğŸ“Š å½“å‰åº“å­˜: {current_stock} ä»¶" }}</textarea>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="previewTemplate('restock')">
                                    <i class="fas fa-eye me-1"></i> é¢„è§ˆæ•ˆæœ
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="resetTemplate('restock')">
                                    <i class="fas fa-undo me-1"></i> é‡ç½®é»˜è®¤
                                </button>
                            </div>
                        </div>
                        
                        <!-- é”€å”®é€šçŸ¥æ¨¡æ¿ -->
                        <div class="mb-3">
                            <label for="template_sale" class="form-label">
                                <i class="fas fa-shopping-cart text-primary me-1"></i>
                                é”€å”®é€šçŸ¥æ¨¡æ¿
                            </label>
                            <textarea class="form-control" id="template_sale" name="template_sale" rows="5" 
                                      placeholder="é”€å”®é€šçŸ¥æ¨¡æ¿">{{ config.template_sale or "ğŸ‰ é”€å”®é€šçŸ¥\n\nğŸ“¦ å•†å“åç§°: {product_name}\nğŸ“ˆ è¢«è´­ä¹°: {stock_difference} ä»¶\nğŸ“Š å‰©ä½™åº“å­˜: {current_stock} ä»¶" }}</textarea>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="previewTemplate('sale')">
                                    <i class="fas fa-eye me-1"></i> é¢„è§ˆæ•ˆæœ
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="resetTemplate('sale')">
                                    <i class="fas fa-undo me-1"></i> é‡ç½®é»˜è®¤
                                </button>
                            </div>
                        </div>

                        <!-- å¯ç”¨å˜é‡è¯´æ˜ -->
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-1"></i> å¯ç”¨å˜é‡å’Œè¯´æ˜</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <code>{product_name}</code> - å•†å“åç§°<br>
                                    <code>{current_stock}</code> - å½“å‰åº“å­˜<br>
                                    <code>{stock_difference}</code> - åº“å­˜å˜åŒ–æ•°é‡
                                </div>
                                <div class="col-md-6">
                                    <code>{previous_stock}</code> - ä¹‹å‰åº“å­˜<br>
                                    <code>{check_time}</code> - æ£€æµ‹æ—¶é—´<br>
                                    <small class="text-muted">æ³¨æ„ï¼šè´­ä¹°é“¾æ¥å°†è‡ªåŠ¨æ˜¾ç¤ºä¸ºæŒ‰é’®</small>
                                </div>
                            </div>
                            <div class="mt-2">
                                <strong>ğŸ’¡ æç¤ºï¼š</strong>è´­ä¹°é“¾æ¥ä¸éœ€è¦åœ¨æ¨¡æ¿ä¸­æ·»åŠ ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨æ¶ˆæ¯ä¸‹æ–¹æ˜¾ç¤º"ğŸ›’ å‰å¾€è´­ä¹°"æŒ‰é’®
                            </div>
                        </div>
                    </div>

                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> ä¿å­˜è®¾ç½®
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ç³»ç»Ÿä¿¡æ¯ä¾§è¾¹æ  -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    ç³»ç»ŸçŠ¶æ€
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted">ç›‘æ§çŠ¶æ€</small>
                    <div class="fw-bold text-success">
                        <i class="fas fa-circle me-1"></i> è¿è¡Œä¸­
                    </div>
                </div>
                <div class="mb-3">
                    <small class="text-muted">å½“å‰æ—¶é—´ (äº’è”ç½‘æ—¶é—´)</small>
                    <div class="fw-bold text-info" id="current-internet-time">-</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted">ä¸Šæ¬¡æ£€æµ‹</small>
                    <div class="fw-bold" id="last-check-time">åˆšåˆš</div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-tools me-1"></i>
                    ç³»ç»Ÿç»´æŠ¤
                </h6>
            </div>
            <div class="card-body">
                <!-- å¤‡ä»½åŠŸèƒ½ -->
                <div class="mb-3">
                    <h6 class="text-muted mb-2">
                        <i class="fas fa-database me-1"></i> æ•°æ®å¤‡ä»½
                    </h6>
                    <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="exportData()">
                        <i class="fas fa-download me-1"></i> å¯¼å‡ºå¤‡ä»½æ•°æ®
                    </button>
                    <div class="input-group mb-2">
                        <input type="file" class="form-control form-control-sm" id="backup_file_input" accept=".json">
                        <button class="btn btn-outline-success btn-sm" type="button" onclick="importData()">
                            <i class="fas fa-upload me-1"></i> å¯¼å…¥
                        </button>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        å¯¼å‡ºåŒ…å«æ‰€æœ‰å•†å“ã€é…ç½®å’Œå†å²æ•°æ®
                    </small>
                </div>
                
                <!-- æ—¶é—´åŒæ­¥åŠŸèƒ½ -->
                <div class="mb-3">
                    <h6 class="text-muted mb-2">
                        <i class="fas fa-clock me-1"></i> æ—¶é—´åŒæ­¥
                    </h6>
                    <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="syncInternetTime()">
                        <i class="fas fa-sync me-1"></i> åŒæ­¥äº’è”ç½‘æ—¶é—´
                    </button>
                    <small class="text-muted mt-1 d-block">
                        <i class="fas fa-info-circle me-1"></i>
                        ä»äº’è”ç½‘è·å–å‡†ç¡®æ—¶é—´ (ä¸­å›½æ—¶åŒº)
                    </small>
                </div>
                
                <hr>
                
                <!-- ç³»ç»Ÿç»´æŠ¤ -->
                <div class="mb-3">
                    <h6 class="text-muted mb-2">
                        <i class="fas fa-tools me-1"></i> ç³»ç»Ÿç»´æŠ¤
                    </h6>
                    <button type="button" class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="clearLogs()">
                        <i class="fas fa-broom me-1"></i> æ¸…ç†ç³»ç»Ÿæ—¥å¿—
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm w-100 mb-2" onclick="window.location.href='/logs'">
                        <i class="fas fa-file-alt me-1"></i> æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="window.location.href='/change_password'">
                        <i class="fas fa-key me-1"></i> ä¿®æ”¹ç™»å½•å¯†ç 
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showBotHelp() {
    Swal.fire({
        title: 'å¦‚ä½•åˆ›å»ºTelegram Botï¼Ÿ',
        html: `
            <div class="text-start">
                <ol>
                    <li>åœ¨Telegramä¸­æœç´¢ <code>@BotFather</code></li>
                    <li>å‘é€ <code>/newbot</code> å‘½ä»¤</li>
                    <li>æŒ‰æç¤ºè®¾ç½®Botåç§°å’Œç”¨æˆ·å</li>
                    <li>å¤åˆ¶è·å¾—çš„Bot Tokenåˆ°ä¸Šé¢çš„è¾“å…¥æ¡†</li>
                    <li>å°†Botæ·»åŠ åˆ°æ‚¨çš„é¢‘é“/ç¾¤ç»„å¹¶è®¾ä¸ºç®¡ç†å‘˜</li>
                </ol>
                <div class="alert alert-info mt-3">
                    <strong>æ³¨æ„ï¼š</strong>Botéœ€è¦æœ‰å‘é€æ¶ˆæ¯çš„æƒé™
                </div>
            </div>
        `,
        icon: 'info',
        confirmButtonText: 'çŸ¥é“äº†'
    });
}

function testNotification(type) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> å‘é€ä¸­...';
    
    fetch('/test_notification', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: type
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                title: 'æµ‹è¯•æˆåŠŸï¼',
                text: 'é€šçŸ¥å·²å‘é€ï¼Œè¯·æ£€æŸ¥æ‚¨çš„Telegram',
                icon: 'success',
                timer: 3000
            });
        } else {
            Swal.fire({
                title: 'æµ‹è¯•å¤±è´¥',
                text: data.message || 'å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®',
                icon: 'error'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            title: 'ç½‘ç»œé”™è¯¯',
            text: 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
            icon: 'error'
        });
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

function previewTemplate(type) {
    const templates = {
        'restock': 'ğŸ‰ è¡¥è´§é€šçŸ¥\n\nğŸ“¦ å•†å“åç§°: {product_name}\nğŸ“ˆ è¡¥è´§æ•°é‡: {stock_difference} ä»¶\nğŸ“Š å½“å‰åº“å­˜: {current_stock} ä»¶',
        'sale': 'ğŸ‰ é”€å”®é€šçŸ¥\n\nğŸ“¦ å•†å“åç§°: {product_name}\nğŸ“ˆ è¢«è´­ä¹°: {stock_difference} ä»¶\nğŸ“Š å‰©ä½™åº“å­˜: {current_stock} ä»¶'
    };

    const templateText = document.getElementById('template_' + type).value || templates[type];
    
    // ç¤ºä¾‹æ•°æ®
    const sampleData = {
        product_name: 'åä¸ºäº‘2',
        current_stock: type === 'restock' ? 5 : 3,
        stock_difference: type === 'restock' ? 2 : 1,
        previous_stock: type === 'restock' ? 3 : 4,
        check_time: new Date().toLocaleString('zh-CN'),
        buy_url: 'https://example.com/buy'
    };
    
    // æ›¿æ¢å˜é‡
    let previewText = templateText;
    Object.keys(sampleData).forEach(key => {
        const regex = new RegExp(`{${key}}`, 'g');
        previewText = previewText.replace(regex, sampleData[key]);
    });
    
    Swal.fire({
        title: type === 'restock' ? 'è¡¥è´§é€šçŸ¥é¢„è§ˆ' : 'é”€å”®é€šçŸ¥é¢„è§ˆ',
        html: '<div class="text-start"><pre style="white-space: pre-wrap; font-family: inherit;">' + previewText + '</pre><div class="mt-3"><button class="btn btn-primary btn-sm" disabled>ğŸ›’ å‰å¾€è´­ä¹°</button><small class="text-muted ms-2">ï¼ˆå®é™…å‘é€æ—¶ä¸ºå¯ç‚¹å‡»æŒ‰é’®ï¼‰</small></div></div>',
        icon: 'info',
        confirmButtonText: 'å…³é—­'
    });
}

function resetTemplate(type) {
    const templates = {
        'restock': 'ğŸ‰ è¡¥è´§é€šçŸ¥\n\nğŸ“¦ å•†å“åç§°: {product_name}\nğŸ“ˆ è¡¥è´§æ•°é‡: {stock_difference} ä»¶\nğŸ“Š å½“å‰åº“å­˜: {current_stock} ä»¶',
        'sale': 'ğŸ‰ é”€å”®é€šçŸ¥\n\nğŸ“¦ å•†å“åç§°: {product_name}\nğŸ“ˆ è¢«è´­ä¹°: {stock_difference} ä»¶\nğŸ“Š å‰©ä½™åº“å­˜: {current_stock} ä»¶'
    };
    
    Swal.fire({
        title: 'ç¡®è®¤é‡ç½®',
        text: 'ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿å—ï¼Ÿå½“å‰å†…å®¹å°†è¢«è¦†ç›–ã€‚',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'é‡ç½®',
        cancelButtonText: 'å–æ¶ˆ'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('template_' + type).value = templates[type];
            Swal.fire('å·²é‡ç½®', 'æ¨¡æ¿å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 'success');
        }
    });
}

function exportData() {
    Swal.fire({
        title: 'å¯¼å‡ºå¤‡ä»½æ•°æ®',
        text: 'æ­£åœ¨ç”Ÿæˆå¤‡ä»½æ–‡ä»¶...',
        icon: 'info',
        showConfirmButton: false,
        allowOutsideClick: false
    });

    fetch('/api/export_data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«æ—¶é—´æˆ³ï¼‰
                const now = new Date();
                const timestamp = now.getFullYear() + 
                    String(now.getMonth() + 1).padStart(2, '0') + 
                    String(now.getDate()).padStart(2, '0') + '_' +
                    String(now.getHours()).padStart(2, '0') + 
                    String(now.getMinutes()).padStart(2, '0');
                a.download = `inventory_backup_${timestamp}.json`;
                
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                Swal.fire('å¯¼å‡ºæˆåŠŸ', data.message, 'success');
            } else {
                Swal.fire('å¯¼å‡ºå¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('ç½‘ç»œé”™è¯¯', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        });
}

function importData() {
    const fileInput = document.getElementById('backup_file_input');
    const file = fileInput.files[0];
    
    if (!file) {
        Swal.fire('è¯·é€‰æ‹©æ–‡ä»¶', 'è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„å¤‡ä»½æ–‡ä»¶', 'warning');
        return;
    }
    
    if (!file.name.endsWith('.json')) {
        Swal.fire('æ–‡ä»¶æ ¼å¼é”™è¯¯', 'è¯·é€‰æ‹©JSONæ ¼å¼çš„å¤‡ä»½æ–‡ä»¶', 'error');
        return;
    }
    
    Swal.fire({
        title: 'ç¡®è®¤å¯¼å…¥',
        html: `
            <div class="text-start">
                <p><strong>æ–‡ä»¶å:</strong> ${file.name}</p>
                <p><strong>æ–‡ä»¶å¤§å°:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>æ³¨æ„:</strong>
                    <ul class="mb-0 mt-2">
                        <li>å¯¼å…¥ä¼šæ·»åŠ æ–°çš„å•†å“æ•°æ®ï¼ˆä¸ä¼šè¦†ç›–ç°æœ‰å•†å“ï¼‰</li>
                        <li>å¦‚æœé€šçŸ¥é…ç½®ä¸å­˜åœ¨ï¼Œä¼šå¯¼å…¥å¤‡ä»½çš„é…ç½®</li>
                        <li>å»ºè®®åœ¨å¯¼å…¥å‰å…ˆå¯¼å‡ºå½“å‰æ•°æ®ä½œä¸ºå¤‡ä»½</li>
                    </ul>
                </div>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ç¡®è®¤å¯¼å…¥',
        cancelButtonText: 'å–æ¶ˆ',
        confirmButtonColor: '#28a745'
    }).then((result) => {
        if (result.isConfirmed) {
            const formData = new FormData();
            formData.append('backup_file', file);
            
            Swal.fire({
                title: 'å¯¼å…¥ä¸­...',
                text: 'æ­£åœ¨å¤„ç†å¤‡ä»½æ–‡ä»¶ï¼Œè¯·ç¨å€™',
                icon: 'info',
                showConfirmButton: false,
                allowOutsideClick: false
            });
            
            fetch('/api/import_data', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: 'å¯¼å…¥æˆåŠŸ',
                        text: data.message,
                        icon: 'success',
                        confirmButtonText: 'åˆ·æ–°é¡µé¢'
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire('å¯¼å…¥å¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('ç½‘ç»œé”™è¯¯', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            });
        }
    });
}

function clearLogs() {
    Swal.fire({
        title: 'æ¸…ç†ç³»ç»Ÿæ—¥å¿—',
        text: 'ç¡®å®šè¦æ¸…ç†æ‰€æœ‰ç³»ç»Ÿæ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'æ¸…ç†',
        cancelButtonText: 'å–æ¶ˆ'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/clear_logs', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('æ¸…ç†å®Œæˆ', 'ç³»ç»Ÿæ—¥å¿—å·²æ¸…ç†', 'success');
                } else {
                    Swal.fire('æ¸…ç†å¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('ç½‘ç»œé”™è¯¯', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            });
        }
    });
}

// åŒæ­¥äº’è”ç½‘æ—¶é—´
function syncInternetTime() {
    Swal.fire({
        title: 'æ­£åœ¨åŒæ­¥æ—¶é—´...',
        text: 'ä»äº’è”ç½‘è·å–å‡†ç¡®æ—¶é—´ä¸­',
        icon: 'info',
        showConfirmButton: false,
        allowOutsideClick: false
    });
    
    fetch('/api/sync_time', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ›´æ–°é¡µé¢ä¸Šçš„æ—¶é—´æ˜¾ç¤º
            const currentTimeElement = document.getElementById('current-internet-time');
            if (currentTimeElement) {
                currentTimeElement.textContent = data.formatted_time;
            }
            
            Swal.fire({
                title: 'æ—¶é—´åŒæ­¥æˆåŠŸ',
                text: `å½“å‰äº’è”ç½‘æ—¶é—´ï¼š${data.formatted_time}`,
                icon: 'success',
                confirmButtonText: 'ç¡®å®š'
            });
        } else {
            Swal.fire('åŒæ­¥å¤±è´¥', data.error || 'æ—¶é—´åŒæ­¥å¤±è´¥', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('ç½‘ç»œé”™è¯¯', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
    });
}

// å®šæ—¶æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
function updateCurrentTime() {
    fetch('/api/system_status')
        .then(response => response.json())
        .then(data => {
            const currentTimeElement = document.getElementById('current-internet-time');
            if (currentTimeElement && data.current_time_formatted) {
                currentTimeElement.textContent = data.current_time_formatted;
            }
        })
        .catch(error => {
            console.error('æ›´æ–°æ—¶é—´å¤±è´¥:', error);
        });
}

// é¡µé¢åŠ è½½æ—¶å¼€å§‹å®šæ—¶æ›´æ–°
document.addEventListener('DOMContentLoaded', function() {
    updateCurrentTime(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
    setInterval(updateCurrentTime, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
});
</script>
{% endblock %}