{% extends "base.html" %}

{% block title %}商品管理 - EDUKY-商品监控系统{% endblock %}

{% block page_title %}商品管理{% endblock %}

{% block page_actions %}
<a href="{{ url_for('add_product') }}" class="btn btn-primary">
    <i class="fas fa-plus me-1"></i>
    添加商品
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if products %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>商品名称</th>
                                <th>监控URL</th>
                                <th>CSS选择器</th>
                                <th>当前库存</th>
                                <th>阈值</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr data-product-id="{{ product.id }}">
                                <td>{{ product.id }}</td>
                                <td>
                                    <strong>{{ product.name }}</strong>
                                    {% if product.buy_url %}
                                    <br>
                                    <small>
                                        <a href="{{ product.buy_url }}" target="_blank" class="text-decoration-none">
                                            <i class="fas fa-shopping-cart"></i> 购买链接
                                        </a>
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ product.url }}" target="_blank" class="text-decoration-none">
                                        {{ product.url[:50] }}{% if product.url|length > 50 %}...{% endif %}
                                        <i class="fas fa-external-link-alt ms-1"></i>
                                    </a>
                                </td>
                                <td>
                                    <code>{{ product.target_selector }}</code>
                                </td>
                                <td>
                                    <span class="badge bg-{% if product.current_stock > 0 %}success{% else %}danger{% endif %} fs-6">
                                        {{ product.current_stock }}
                                    </span>
                                </td>
                                <td>{{ product.threshold }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if product.is_active else 'secondary' }}">
                                        {{ '监控中' if product.is_active else '已暂停' }}
                                    </span>
                                </td>
                                <td>{{ product.created_at|china_time_short if product.created_at else '-' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-{{ 'success' if product.is_active else 'warning' }}" 
                                                data-product-id="{{ product.id }}" 
                                                data-product-name="{{ product.name }}" 
                                                onclick="toggleProductStatus(this)" 
                                                title="{{ '暂停监控' if product.is_active else '启用监控' }}">
                                            <i class="fas fa-{{ 'pause' if product.is_active else 'play' }}"></i>
                                        </button>
                                        <a href="{{ url_for('edit_product', id=product.id) }}" class="btn btn-outline-primary" title="编辑">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-info" data-product-id="{{ product.id }}" onclick="testMonitor(this)" title="测试监控">
                                            <i class="fas fa-search"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" data-product-id="{{ product.id }}" data-product-name="{{ product.name }}" onclick="deleteProduct(this)" title="删除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">暂无商品</h5>
                    <p class="text-muted">开始添加第一个商品来监控库存变化</p>
                    <a href="{{ url_for('add_product') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>
                        添加商品
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除商品 "<span id="deleteName"></span>" 吗？</p>
                <p class="text-muted">此操作不可恢复，将同时删除相关的库存历史记录。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">确认删除</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function deleteProduct(button) {
    const id = button.getAttribute('data-product-id');
    const name = button.getAttribute('data-product-name');
    document.getElementById('deleteName').textContent = name;
    document.getElementById('deleteForm').action = `/delete_product/${id}`;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function testMonitor(button) {
    const productId = button.getAttribute('data-product-id');
    const originalHtml = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch(`/api/test_monitor/${productId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`测试成功！当前库存: ${data.stock}`, 'success');
            // 刷新页面数据
            refreshProductData();
        } else {
            showAlert(`测试失败: ${data.message}`, 'danger');
        }
    })
    .catch(error => {
        showAlert('网络错误', 'danger');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalHtml;
    });
}

// 切换商品监控状态
function toggleProductStatus(button) {
    const productId = button.getAttribute('data-product-id');
    const productName = button.getAttribute('data-product-name');
    const originalHtml = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch(`/api/toggle_product_status/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            
            // 更新按钮状态
            const isActive = data.is_active;
            button.className = `btn btn-outline-${isActive ? 'success' : 'warning'} btn-sm`;
            button.innerHTML = `<i class="fas fa-${isActive ? 'pause' : 'play'}"></i>`;
            button.title = isActive ? '暂停监控' : '启用监控';
            
            // 更新状态显示 - 使用更精确的选择器
            const row = document.querySelector(`tr[data-product-id="${productId}"]`);
            if (row) {
                const statusCell = row.children[4]; // 状态列是第5列（索引4）
                const statusBadge = statusCell.querySelector('.badge');
                if (statusBadge) {
                    statusBadge.className = `badge bg-${isActive ? 'success' : 'secondary'}`;
                    statusBadge.textContent = isActive ? '监控中' : '已暂停';
                }
            }
            
        } else {
            showAlert(`操作失败: ${data.message}`, 'danger');
            button.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        showAlert('网络错误: ' + error.message, 'danger');
        button.innerHTML = originalHtml;
    })
    .finally(() => {
        button.disabled = false;
    });
}

// 刷新商品数据
function refreshProductData() {
    fetch('/api/products')
        .then(response => response.json())
        .then(products => {
            products.forEach(product => {
                const row = document.querySelector(`tr[data-product-id="${product.id}"]`);
                if (row) {
                    // 更新库存显示 - 第3列（索引2）
                    const stockCell = row.children[2];
                    const stockBadge = stockCell.querySelector('.badge');
                    if (stockBadge) {
                        stockBadge.textContent = product.current_stock || 0;
                        stockBadge.className = `badge fs-6 ${product.current_stock > 0 ? 'bg-success' : 'bg-danger'}`;
                    }
                    
                    // 更新监控状态 - 第5列（索引4）
                    const statusCell = row.children[4];
                    const statusBadge = statusCell.querySelector('.badge');
                    if (statusBadge) {
                        statusBadge.className = `badge bg-${product.is_active ? 'success' : 'secondary'}`;
                        statusBadge.textContent = product.is_active ? '监控中' : '已暂停';
                    }
                    
                    // 更新按钮状态
                    const toggleButton = row.querySelector('button[data-product-id]');
                    if (toggleButton) {
                        toggleButton.className = `btn btn-outline-${product.is_active ? 'success' : 'warning'} btn-sm`;
                        toggleButton.innerHTML = `<i class="fas fa-${product.is_active ? 'pause' : 'play'}"></i>`;
                        toggleButton.title = product.is_active ? '暂停监控' : '启用监控';
                    }
                }
            });
        })
        .catch(error => console.error('刷新商品数据失败:', error));
}

// 定时刷新数据
setInterval(refreshProductData, 30000); // 每30秒刷新一次
</script>
{% endblock %}