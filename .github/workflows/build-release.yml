name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            ext: .exe
            python-version: '3.9'
          - os: ubuntu-latest
            platform: linux
            ext: ''
            python-version: '3.9'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Create build script (Windows)
      if: matrix.platform == 'windows'
      run: |
        echo @echo off > build.bat
        echo echo Building EDUKY-Monitor for Windows... >> build.bat
        echo pyinstaller --onefile --windowed --name eduky-monitor-windows --icon=web/static/favicon.ico --add-data "web;web" --add-data "logs;logs" --hidden-import=APScheduler --hidden-import=flask --hidden-import=requests run_app.py >> build.bat
        echo echo Build completed! >> build.bat
      shell: cmd

    - name: Create build script (Linux)
      if: matrix.platform == 'linux'
      run: |
        cat > build.sh << 'EOF'
        #!/bin/bash
        echo "Building EDUKY-Monitor for Linux..."
        pyinstaller --onefile --name eduky-monitor-linux \
          --add-data "web:web" \
          --add-data "logs:logs" \
          --hidden-import=APScheduler \
          --hidden-import=flask \
          --hidden-import=requests \
          run_app.py
        echo "Build completed!"
        EOF
        chmod +x build.sh

    - name: Build executable (Windows)
      if: matrix.platform == 'windows'
      run: build.bat
      shell: cmd

    - name: Build executable (Linux)
      if: matrix.platform == 'linux'
      run: ./build.sh

    - name: Create startup script (Windows)
      if: matrix.platform == 'windows'
      run: |
        echo @echo off > dist/start-eduky-monitor.bat
        echo echo Starting EDUKY-Monitor... >> dist/start-eduky-monitor.bat
        echo eduky-monitor-windows.exe >> dist/start-eduky-monitor.bat
        echo pause >> dist/start-eduky-monitor.bat

    - name: Create startup script (Linux)
      if: matrix.platform == 'linux'
      run: |
        cat > dist/start-eduky-monitor.sh << 'EOF'
        #!/bin/bash
        echo "Starting EDUKY-Monitor..."
        ./eduky-monitor-linux
        EOF
        chmod +x dist/start-eduky-monitor.sh

    - name: Create README for release (Windows)
      if: matrix.platform == 'windows'
      run: |
        echo # EDUKY-Monitor Windows å‘è¡Œç‰ˆ > dist/README.txt
        echo. >> dist/README.txt
        echo ## å¿«é€Ÿå¼€å§‹ >> dist/README.txt
        echo 1. åŒå‡» start-eduky-monitor.bat å¯åŠ¨ç¨‹åº >> dist/README.txt
        echo 2. æ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:5000 >> dist/README.txt
        echo 3. é»˜è®¤ç”¨æˆ·å: admin, é»˜è®¤å¯†ç : admin123 >> dist/README.txt
        echo. >> dist/README.txt
        echo ## è¯´æ˜ >> dist/README.txt
        echo - ç¨‹åºä¼šåœ¨åå°è¿è¡Œï¼Œå…³é—­å‘½ä»¤è¡Œçª—å£å³å¯åœæ­¢ >> dist/README.txt
        echo - æ•°æ®åº“æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ›å»ºåœ¨ç¨‹åºç›®å½•ä¸‹ >> dist/README.txt
        echo - æ—¥å¿—æ–‡ä»¶ä¿å­˜åœ¨ logs ç›®å½•ä¸­ >> dist/README.txt

    - name: Create README for release (Linux)
      if: matrix.platform == 'linux'
      run: |
        cat > dist/README.md << 'EOF'
        # EDUKY-Monitor Linux å‘è¡Œç‰ˆ

        ## å¿«é€Ÿå¼€å§‹
        1. è¿è¡Œå¯åŠ¨è„šæœ¬: `./start-eduky-monitor.sh`
        2. æ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:5000
        3. é»˜è®¤ç”¨æˆ·å: admin, é»˜è®¤å¯†ç : admin123

        ## è¯´æ˜
        - ç¨‹åºä¼šåœ¨å‰å°è¿è¡Œï¼ŒæŒ‰ Ctrl+C åœæ­¢
        - æ•°æ®åº“æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ›å»ºåœ¨ç¨‹åºç›®å½•ä¸‹
        - æ—¥å¿—æ–‡ä»¶ä¿å­˜åœ¨ logs ç›®å½•ä¸­

        ## ç³»ç»ŸæœåŠ¡å®‰è£… (å¯é€‰)
        å¦‚éœ€å®‰è£…ä¸ºç³»ç»ŸæœåŠ¡ï¼Œè¯·ä½¿ç”¨é¡¹ç›®ä¸­çš„è„šæœ¬:
        ```bash
        # ä¸‹è½½å®Œæ•´é¡¹ç›®
        git clone https://github.com/eduky/EDUKY-Monitor.git
        cd EDUKY-Monitor/scripts/linux
        sudo ./install_systemd.sh
        ```
        EOF

    - name: Package files (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir package
        copy dist\eduky-monitor-windows.exe package\
        copy dist\start-eduky-monitor.bat package\
        copy dist\README.txt package\
        mkdir package\logs
        echo. > package\logs\.gitkeep
      shell: cmd

    - name: Package files (Linux)
      if: matrix.platform == 'linux'
      run: |
        mkdir package
        cp dist/eduky-monitor-linux package/
        cp dist/start-eduky-monitor.sh package/
        cp dist/README.md package/
        mkdir package/logs
        touch package/logs/.gitkeep

    - name: Create archive (Windows)
      if: matrix.platform == 'windows'
      run: |
        cd package
        tar -czf ../eduky-monitor-${{ matrix.platform }}.tar.gz *
      shell: bash

    - name: Create archive (Linux)
      if: matrix.platform == 'linux'
      run: |
        cd package
        tar -czf ../eduky-monitor-${{ matrix.platform }}.tar.gz *

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: eduky-monitor-${{ matrix.platform }}
        path: eduky-monitor-${{ matrix.platform }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Get release version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        release_name: EDUKY-Monitor ${{ steps.get_version.outputs.version }}
        body: |
          ## EDUKY-Monitor ${{ steps.get_version.outputs.version }} å‘è¡Œç‰ˆ

          ### ğŸš€ æ–°ç‰¹æ€§
          - å®Œæ•´çš„åº“å­˜ç›‘æ§ç³»ç»Ÿ
          - Webç•Œé¢ç®¡ç†
          - å¤šå¹³å°æ”¯æŒ

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          **Windows ç”¨æˆ·:**
          - ä¸‹è½½ `eduky-monitor-windows.tar.gz`
          - è§£å‹ååŒå‡» `start-eduky-monitor.bat` å¯åŠ¨

          **Linux ç”¨æˆ·:**
          - ä¸‹è½½ `eduky-monitor-linux.tar.gz`
          - è§£å‹åè¿è¡Œ `./start-eduky-monitor.sh` å¯åŠ¨

          ### ğŸŒ è®¿é—®æ–¹å¼
          å¯åŠ¨ååœ¨æµè§ˆå™¨ä¸­è®¿é—®: http://localhost:5000
          
          **é»˜è®¤ç™»å½•ä¿¡æ¯:**
          - ç”¨æˆ·å: `admin`
          - å¯†ç : `admin123`

          ### ğŸ“ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“
          - å»ºè®®é¦–æ¬¡ç™»å½•åç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç 
          - ç¨‹åºæ•°æ®ä¿å­˜åœ¨è¿è¡Œç›®å½•ä¸‹
        draft: false
        prerelease: false

    - name: Upload Windows Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./eduky-monitor-windows/eduky-monitor-windows.tar.gz
        asset_name: eduky-monitor-windows.tar.gz
        asset_content_type: application/gzip

    - name: Upload Linux Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./eduky-monitor-linux/eduky-monitor-linux.tar.gz
        asset_name: eduky-monitor-linux.tar.gz
        asset_content_type: application/gzip